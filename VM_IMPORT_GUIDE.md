# VM 批量导入功能使用指南

## 功能概述

VM 批量导入功能允许管理员通过上传 CSV 文件一次性导入多条 VM 记录。系统会自动验证数据，只导入符合规则的记录，并提供详细的错误报告。

## 使用步骤

### 1. 准备 CSV 文件

#### 必需字段

| 字段名 | 说明 | 验证规则 | 示例 |
|--------|------|----------|------|
| `email` | 联系邮箱 | 必填，有效的邮箱格式 | `user@example.com` |
| `vmAccount` | VM 账户名 | 必填，全局唯一 | `vm-account-001` |
| `vmInternalIP` | VM 内网 IP | 必填，有效的 IP 地址格式 | `192.168.1.100` |
| `vmDomain` | VM 域名 | 必填，有效的域名格式 | `vm001.example.com` |
| `currentExpiryDate` | 当前到期日期 | 必填，YYYY-MM-DD 格式 | `2026-06-30` |
| `projectCode` | 项目代码 | 必填，必须是已存在的项目名称 | `PROJECT-001` |

#### 可选字段

| 字段名 | 说明 | 验证规则 | 示例 |
|--------|------|----------|------|
| `lastExpiryDate` | 上次到期日期 | 可选，YYYY-MM-DD 格式 | `2026-03-31` |

### 2. CSV 文件格式示例

```csv
email,vmAccount,vmInternalIP,vmDomain,currentExpiryDate,projectCode,lastExpiryDate
user@example.com,vm-account-001,192.168.1.100,vm001.example.com,2026-06-30,PROJECT-001,2026-03-31
admin@example.com,vm-account-002,192.168.1.101,vm002.example.com,2026-07-15,PROJECT-002,
```

**注意事项：**
- 第一行必须是字段名（表头）
- 字段之间用英文逗号分隔
- 可选字段可以留空，但逗号不能省略
- 不要在字段值中使用逗号

### 3. 下载模板

在 VM 列表页面点击 **"Import CSV"** 按钮，在弹出的对话框中点击 **"Download Template"** 下载标准模板。

### 4. 上传文件

1. 点击 **"Import CSV"** 按钮
2. 在对话框中点击 **"Select CSV File"** 选择准备好的 CSV 文件
3. 点击 **"Import"** 开始导入

### 5. 查看导入结果

导入完成后，系统会显示详细的导入报告：

#### 成功导入
- 显示成功导入的记录数量
- 如果全部成功，对话框会自动关闭并刷新列表

#### 部分失败
- 显示成功和失败的记录数量
- 列出所有验证错误和导入错误
- 成功的记录已保存，失败的记录不受影响

## 数据验证规则

### 1. 必填字段验证
所有必填字段不能为空或只包含空格。

### 2. 邮箱格式验证
```
✓ 正确: user@example.com
✗ 错误: user@, @example.com, user.example.com
```

### 3. VM 账户唯一性验证
- 不能与系统中已存在的 VM 账户重复
- 不能在同一个导入文件中重复

### 4. IP 地址格式验证
```
✓ 正确: 192.168.1.100, 10.0.0.1
✗ 错误: 192.168.1.256, 192.168.1, abc.def.ghi.jkl
```

### 5. 域名格式验证
```
✓ 正确: vm001.example.com, server-01.local
✗ 错误: vm, -invalid.com, .example.com
```

### 6. 日期格式验证
```
✓ 正确: 2026-06-30, 2026-01-01
✗ 错误: 06/30/2026, 2026/06/30, 30-06-2026
```

### 7. 项目代码验证
- 必须是系统中已存在的项目名称
- 区分大小写

## 常见错误及解决方案

### 错误 1: "Email is required"
**原因：** 邮箱字段为空  
**解决：** 确保每行都填写了有效的邮箱地址

### 错误 2: "VM Account already exists (duplicate)"
**原因：** VM 账户名已存在于系统中  
**解决：** 使用不同的 VM 账户名

### 错误 3: "Duplicate VM Account within import file"
**原因：** 同一个 CSV 文件中有重复的 VM 账户名  
**解决：** 检查并删除重复的行

### 错误 4: "Invalid IP address format"
**原因：** IP 地址格式不正确  
**解决：** 使用标准的 IPv4 格式（如 192.168.1.100）

### 错误 5: "Invalid date format (use YYYY-MM-DD)"
**原因：** 日期格式不正确  
**解决：** 使用 YYYY-MM-DD 格式（如 2026-06-30）

### 错误 6: "Project 'XXX' not found"
**原因：** 项目代码不存在  
**解决：** 确认项目名称正确，或先创建该项目

### 错误 7: "Missing required columns"
**原因：** CSV 文件缺少必需的列  
**解决：** 确保 CSV 文件包含所有必需的字段名

## 最佳实践

### 1. 分批导入
如果有大量数据，建议分批导入（每批 50-100 条），便于排查问题。

### 2. 先验证后导入
在正式导入前，可以先用少量数据测试，确保格式正确。

### 3. 备份现有数据
在大批量导入前，建议先导出现有数据作为备份。

### 4. 检查项目
确保所有需要的项目已经在系统中创建。

### 5. 使用模板
始终从系统下载的模板开始，避免格式错误。

## 导入流程图

```
┌─────────────────┐
│  准备 CSV 文件   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  上传文件        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  解析 CSV        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  验证数据        │
│  - 格式验证      │
│  - 唯一性验证    │
│  - 项目验证      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  导入有效记录    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  显示导入报告    │
│  - 成功数量      │
│  - 失败数量      │
│  - 错误详情      │
└─────────────────┘
```

## 权限要求

- 只有 **管理员（ADMIN）** 可以使用批量导入功能
- 普通用户无法看到导入按钮

## 审计日志

所有导入操作都会记录到审计日志中，包括：
- 导入时间
- 操作用户
- 文件名
- 导入结果统计
- 每条成功导入的记录

## 技术支持

如遇到问题，请联系系统管理员，并提供：
1. 导入的 CSV 文件
2. 错误截图
3. 导入时间

---

**版本：** 1.0.0  
**最后更新：** 2026-01-13
