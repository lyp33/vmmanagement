# VM到期管理系统 - 管理员指南

## 概述

本指南面向VM到期管理系统的管理员用户，涵盖系统管理、用户管理、监控维护和故障排除等高级功能。

## 管理员职责

- 系统配置和维护
- 用户账户和权限管理
- 项目创建和分配管理
- 系统监控和性能优化
- 数据备份和恢复
- 故障排除和技术支持

## 系统管理

### 初始化设置

#### 首次部署后的配置

1. **创建管理员账户**
   ```bash
   # 使用种子脚本创建初始管理员
   npm run db:seed
   ```

2. **验证系统配置**
   ```bash
   # 检查环境变量
   npm run validate:env
   
   # 健康检查
   curl https://your-domain.vercel.app/api/health
   ```

3. **测试邮件服务**
   - 访问 `/api/notifications/test`
   - 验证邮件发送功能正常

#### 环境变量管理

在 Vercel 控制台配置以下环境变量：

| 变量名 | 用途 | 示例值 |
|--------|------|--------|
| `DATABASE_URL` | 数据库连接 | `postgresql://...` |
| `NEXTAUTH_SECRET` | JWT 签名密钥 | `your-secret-key` |
| `RESEND_API_KEY` | 邮件服务密钥 | `re_xxxxxxxxxx` |
| `FROM_EMAIL` | 发件人邮箱 | `admin@company.com` |
| `CRON_SECRET` | 定时任务密钥 | `cron-secret-key` |

### 用户管理

#### 创建用户账户

目前系统不支持自助注册，需要管理员手动创建：

1. 直接在数据库中添加用户记录
2. 或通过管理界面创建（如已实现）

```sql
-- 示例：创建新用户
INSERT INTO "User" (id, email, name, role, "createdAt", "updatedAt")
VALUES (
  'user_id_here',
  'user@company.com',
  'User Name',
  'USER',
  NOW(),
  NOW()
);
```

#### 用户角色管理

**管理员角色 (ADMIN)**
- 访问所有系统功能
- 管理所有项目和VM
- 查看审计日志
- 管理用户权限

**普通用户角色 (USER)**
- 只能访问分配的项目
- 管理项目内的VM记录
- 无法访问系统管理功能

#### 项目分配管理

1. **查看用户项目分配**
   - 访问用户管理页面
   - 查看每个用户的项目分配情况

2. **分配用户到项目**
   ```sql
   -- 示例：分配用户到项目
   INSERT INTO "ProjectAssignment" (id, "userId", "projectId", "assignedAt")
   VALUES (
     'assignment_id',
     'user_id',
     'project_id',
     NOW()
   );
   ```

3. **移除项目分配**
   - 在项目管理页面移除用户分配
   - 用户将失去该项目的访问权限

### 项目管理

#### 创建项目

1. 访问项目管理页面
2. 点击"创建项目"
3. 填写项目信息：
   - 项目名称（唯一标识）
   - 项目描述
4. 保存项目

#### 项目维护

- **编辑项目信息**：更新项目名称和描述
- **查看项目统计**：VM数量、用户分配等
- **管理项目用户**：分配和移除用户权限

#### 删除项目

⚠️ **注意**：删除项目前必须：
1. 删除或转移项目下的所有VM记录
2. 移除所有用户分配
3. 确认无其他依赖关系

## 监控和维护

### 系统健康监控

#### 健康检查端点

```bash
# 基本健康检查
curl https://your-domain.vercel.app/api/health

# 预期响应
{
  "status": "healthy",
  "timestamp": "2024-01-04T10:00:00.000Z",
  "environment": "production",
  "version": "1.0.0",
  "checks": {
    "database": "healthy",
    "email": "configured",
    "auth": "configured"
  }
}
```

#### 监控指标

定期检查以下指标：
- **响应时间**：API 响应时间 < 2秒
- **错误率**：错误率 < 1%
- **数据库连接**：连接池使用率 < 80%
- **邮件发送**：成功率 > 95%

### 日志管理

#### 查看应用日志

1. **Vercel 函数日志**
   - 访问 Vercel 控制台
   - 选择项目 → Functions
   - 查看实时日志

2. **审计日志**
   - 系统内置审计日志
   - 记录所有数据修改操作
   - 支持按时间、用户、操作类型筛选

#### 日志分析

关注以下日志模式：
- **错误频率**：异常错误增加
- **性能问题**：响应时间异常
- **安全事件**：异常登录尝试
- **数据异常**：批量操作失败

### 定时任务管理

#### 到期检查任务

系统配置的定时任务：
```json
{
  "crons": [
    {
      "path": "/api/cron/check-expiry",
      "schedule": "0 9 * * *"
    }
  ]
}
```

#### 监控定时任务

1. **检查执行状态**
   - 在 Vercel 控制台查看 Cron 执行日志
   - 确认每日正常执行

2. **手动触发测试**
   ```bash
   # 手动触发到期检查
   curl -X POST https://your-domain.vercel.app/api/cron/check-expiry \
     -H "Authorization: Bearer your-cron-secret"
   ```

3. **故障处理**
   - 检查邮件服务配置
   - 验证数据库连接
   - 查看错误日志

## 数据管理

### 数据备份

#### 定期备份策略

1. **数据库备份**
   - Vercel Postgres 自动备份
   - 建议额外导出重要数据

2. **应用数据导出**
   ```bash
   # 导出VM数据
   curl https://your-domain.vercel.app/api/export \
     -H "Authorization: Bearer admin-token"
   ```

#### 备份验证

定期验证备份数据：
- 检查数据完整性
- 测试恢复流程
- 确认备份可用性

### 数据清理

#### 审计日志清理

系统会自动管理审计日志，但可以手动清理：

```sql
-- 删除90天前的审计日志
DELETE FROM "AuditLog" 
WHERE timestamp < NOW() - INTERVAL '90 days';
```

#### 通知日志清理

```sql
-- 删除30天前的通知日志
DELETE FROM "NotificationLog" 
WHERE "createdAt" < NOW() - INTERVAL '30 days';
```

## 安全管理

### 访问控制

#### 权限审计

定期检查：
- 用户权限分配是否合理
- 项目访问权限是否正确
- 管理员账户数量是否适当

#### 密钥管理

1. **定期轮换密钥**
   - `NEXTAUTH_SECRET`：每6个月更换
   - `RESEND_API_KEY`：根据需要更换
   - `CRON_SECRET`：每年更换

2. **密钥强度要求**
   - 最少32个字符
   - 包含字母、数字、特殊字符
   - 使用加密安全的随机生成器

### 安全监控

#### 异常活动监控

关注以下安全事件：
- 多次登录失败
- 异常时间的操作
- 大量数据导出
- 权限提升尝试

#### 安全响应

发现安全问题时：
1. 立即更改相关密钥
2. 检查审计日志
3. 通知相关用户
4. 加强监控措施

## 故障排除

### 常见问题诊断

#### 1. 数据库连接问题

**症状**：健康检查显示数据库不健康

**诊断步骤**：
```bash
# 检查环境变量
npm run validate:env

# 测试数据库连接
npx prisma db pull
```

**解决方案**：
- 验证数据库URL正确性
- 检查数据库服务状态
- 确认网络连接正常

#### 2. 邮件发送失败

**症状**：到期通知未发送

**诊断步骤**：
1. 检查 Resend API 密钥
2. 验证发送域名状态
3. 查看通知日志

**解决方案**：
- 更新 API 密钥
- 重新验证域名
- 检查邮件模板

#### 3. 定时任务未执行

**症状**：到期检查未自动运行

**诊断步骤**：
1. 查看 Vercel Cron 日志
2. 手动触发测试
3. 检查函数超时

**解决方案**：
- 调整 Cron 配置
- 优化函数性能
- 增加错误处理

### 性能优化

#### 数据库优化

1. **查询优化**
   - 添加适当索引
   - 优化复杂查询
   - 使用连接池

2. **数据清理**
   - 定期清理历史数据
   - 归档旧记录
   - 优化表结构

#### 应用优化

1. **缓存策略**
   - 静态资源缓存
   - API 响应缓存
   - 数据库查询缓存

2. **代码优化**
   - 减少不必要的查询
   - 优化批量操作
   - 改进错误处理

## 升级和维护

### 系统更新

#### 依赖包更新

```bash
# 检查过期依赖
npm outdated

# 更新依赖包
npm update

# 安全漏洞检查
npm audit
```

#### 数据库迁移

```bash
# 创建新迁移
npx prisma migrate dev --name migration_name

# 生产环境迁移
npx prisma migrate deploy
```

### 版本发布

#### 发布流程

1. **测试环境验证**
   - 运行所有测试
   - 验证新功能
   - 检查性能影响

2. **生产环境部署**
   - 备份当前数据
   - 执行数据库迁移
   - 部署新版本
   - 验证系统功能

3. **发布后检查**
   - 监控系统指标
   - 检查错误日志
   - 验证关键功能

## 联系和支持

### 技术支持流程

1. **问题分类**
   - 紧急问题：系统不可用
   - 重要问题：功能异常
   - 一般问题：使用咨询

2. **处理优先级**
   - 紧急：2小时内响应
   - 重要：24小时内响应
   - 一般：72小时内响应

### 文档维护

定期更新以下文档：
- 用户手册
- 管理员指南
- 部署文档
- API 文档

---

**版本**：1.0.0  
**更新时间**：2024年1月4日  
**维护人员**：系统管理员